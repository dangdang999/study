{mtemplate '_header'}
<div class="dm-subnav">
	<div class="subnav-title">营销管理</div>
	<ul>
		<li class="{if $operation == 'display'}active{/if}"><a href="{php echo manage_url(array('r'=>'sales','ac'=>'index','op'=>'display'))}">卡券列表</a></li>
		<!-- {if in_array('store_printer_add',$user_permissionArr)}
		<li class="{if $operation == 'post' && empty($id)}active{/if}"><a href="{php echo manage_url(array('r'=>'store','ac'=>'printer','op'=>'post'))}">添加打印机</a></li>
		{/if}
		{if $operation == 'post' && !empty($id)}<li class="active"><a href="{php echo manage_url(array('r'=>'store','ac'=>'printer','op'=>'post','id'=>$id))}">编辑打印机</a></li>{/if} -->
		
	</ul>
</div>
<div class="dm-container">
<div class="dm-content">
<link href="../addons/deam_food/static/js/dist/select/css/bootstrap-select.css" rel="stylesheet">

{if $operation == 'display'}
<div class="we7-padding-bottom clearfix">
	<div class="pull-left">
		<a href="{php echo manage_url(array('r'=>'sales','ac'=>'index','op'=>'add'))}" class="btn btn-primary we7-padding-horizontal">添加优惠券</a>
	</div>
</div>
{if empty($list)}
<div class="panel we7-panel panel-default">
    <div class="panel-body" style="text-align: center;padding:30px;">
       	还未添加优惠券
    </div>
</div>
{else}
<div class="modal fade" id="put-coupon">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-body">
				<div class="form-group">
					<ul class="nav nav-tabs" role="tablist">
					<li role="presentation" class="active"><a href="#put-qrcode" aria-controls="qrcode" role="tab" data-toggle="tab">二维码</a></li>
				</ul>
				</div>
				<div class="tab-content">
					<div role="tabpanel" class="tab-pane active text-center" id="put-qrcode">
						<div class="mui-content-padded mui-text-center">
							<div class="js-qrcode-block" style="margin:50px 0 50px 0"></div>
						</div>
					</div>
					
				</div>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="quantity-modal" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="myModalLabel">修改库存</h4>
			</div>
			<div class="modal-body clearfix form-horizontal">
				<input type="text" class="form-control" name="quantity" />
				<input type="hidden" name="quantity_coupon_id">
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
				<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="util.ajaxshow('{php echo $this->createWeburl('coupon', array('op' => 'modifystock'))}&quantity=' + $('input[name=quantity]').val() + '&id='+ $('input[name=quantity_coupon_id]').val())">确定</button>
			</div>
		</div>
	</div>
</div>
<form action="" method="post" class="form-horizontal form" enctype="multipart/form-data" id="form">
<div class="table-responsive panel-body">
	<table class="table we7-table table-hover">
		<thead class="navbar-inner">
			<tr>
				<th width="120px">排序</th>
				<th width="120px">卡券名称</th>
				<th width="80px">类型</th>
				<th width="150px">卡券有效期</th>
				<th width="70px" class="text-center">状态</th>
				<th width="100px">库存</th>
				<th width="65px">限领</th>
				<!-- <th width="80px">上架状态</th> -->
				<th style="width:400px; text-align:right;">操作</th>
			</tr>
		</thead>
		<tbody>
		{loop $list $k $item}
		<tr>
			<td>
				<input type="text" class="form-control" name="sortid[{$item['id']}]" value="{$item['displayorder']}">
			</td>
			<td>{$item['title']}</td>
			<td>{if $item['type'] == '2'}代金券{elseif $item['type'] == '5'}优惠券{/if}</td>
			<td>
				{$item['date_info']}
			</td>
			<td class="text-center">
				{if $item['type'] == '2'}
				-
				{else}
				{if $item['status'] == '1'}
				<span class="label label-info">审核中</span>
				{elseif $item['status'] == '2'}
				<span class="label label-danger">未通过</span>
				{elseif $item['status'] == '3'}
				<span class="label label-success">已通过</span>
				{elseif $item['status'] == '4'}
				<span class="label label-default">卡券被商户删除</span>
				{elseif $item['status'] == '5'}
				<span class="label label-warning">已在公众平台投放</span>
				{/if}
				{/if}
			</td>
			<td>{$item['quantity']}</td>
			<td>{$item['get_limit']}</td>
			<!-- <td>
				{if $item['is_display'] == 1}
					<span class="label label-success">上架中</span>
				{else}
					<span class="label label-danger">已下架</span>
				{/if}
			</td> -->
			<td style="text-align:right;">
			{if $item['type'] == 5}
				<a href="#put-coupon" data-toggle="modal" data-cid={$item['id']} class="btn btn-default btn-sm js-publish">投放</a>
				<a href="javascript:;" class="btn btn-default btn-sm change_quantity" data-id="{$item['id']}">修改库存</a>
			{/if}
				<!-- <a href="javascript:;" onclick="util.ajaxshow('{php echo $this->createWeburl('couponmanage', array('op' => 'toggle', 'id' => $item['id']))}')" class="btn btn-default btn-sm toggle-display" title="上架/下架">{if $item['is_display'] == 1}下架{else}上架{/if}</a> -->
				<a href="{php echo manage_url(array('r'=>'sales','ac'=>'index','op'=>'detail', 'id' => $item['id']))}" class="btn btn-success btn-sm" title="查看详情">查看详情</a>
				<a href="{php echo manage_url(array('r'=>'sales','ac'=>'index','op'=>'log','couponid' => $item['id'], 'status' => '0'))}"  class="btn btn-default btn-sm" title="领取记录">领取记录</a>
				<a href="{php echo manage_url(array('r'=>'sales','ac'=>'index','op' => 'delete', 'id' => $item['id']))}"  class="btn btn-default btn-sm" title="删除" onclick="if(!confirm('删除后将不可恢复，确定删除吗?')) return false;">删除</a>
			</td>
		</tr>
		{/loop}
		<tr>
            <td colspan="8">
            	<!-- <a href="{php echo $this->createWebUrl('store',array('op'=>'class','method'=>'post'))}" class="btn btn-default"><i class="fa fa-plus"></i> 添加新分类</a> -->
            	<input type="hidden" name="token" value="{$_W['token']}">
            	<input name="submit" type="submit" class="btn btn-primary" value="提交排序">
            </td>
        </tr>
		</tbody>
	</table>
	{$pager}
</div>
</form>
<script type="text/javascript">
require(['jquery.qrcode'], function(){
	$(document).on('click', '.js-publish', function() {
		cid = $(this).data('cid');
		$.post("{php echo $this->createWeburl('coupon', array('op' => 'publish'))}", {'cid' : cid}, function(data) {
			var data = $.parseJSON(data);
			if (data.message.errno == '0') {
				var coupon = data.message.message;
				
				if (coupon.url) {
					var url = coupon.url;
					$('.js-qrcode-block').html('').qrcode({
						render: 'canvas',
						width: 300,
						height: 300,
						text: url,
					});
				} else if(coupon.coupon.url) {
					var url = coupon.coupon.url;
					$('.js-qrcode-block img').remove();
					$('.js-qrcode-block').append('<img src="'+url+'"/>');
				}
				
			} else {
				$('#put-coupon').modal('hide');
				util.message(data.message.message);
			}
		});
	});
	$('.change_quantity').click(function() {
		coupon_id = $(this).data('id');
		$('input[name="quantity_coupon_id"]').val(coupon_id);
		$('#quantity-modal').modal();
	})
})
</script>
{/if}
{elseif $operation == 'add'}
<style type="text/css">
.dm-content{
	
}
.card_preview_area {
	float: left;
    width: 318px;
    margin-right: 16px;
    padding-bottom: 150px;
    overflow: hidden;
    background: #f6f6f8 url(../addons/deam_food/static/images/topbar.png) no-repeat center 5px;
}
.card_preview_area[style^="background-color"] {
    background-image: url(../addons/deam_food/static/images/topbar_white.png);
}
.card_preview_area .card_body {
    margin: 64px 10px 10px;
}
.card_preview_area .msg_card_cell {
	background-color: #fff;
	*zoom: 1
}

.card_preview_area .logo_area {
	position: relative;
	margin-bottom: 7px;
	line-height: 42px;
	color: #8d8d8d;
	margin-top: -40px
}

.card_preview_area .logo {
	display: block;
	width: 38px;
	height: 38px;
	padding-top: 0;
	margin: 0 auto;
	border-radius: 22px;
	-moz-border-radius: 22px;
	-webkit-border-radius: 22px;
	float: none;
	border: 1px solid #e7e7eb;
	background-color: #fff
}

.card_preview_area .logo img {
	display: block;
	width: 100%;
	height: 100%;
	border-radius: inherit;
	-moz-border-radius: inherit;
	-webkit-border-radius: inherit
}

.card_preview_area .logo img[src=""] {
	display: none
}

.card_preview_area .logo img[src="http"] {
	display: block
}

.card_preview_area .logo img[src="//"] {
	display: block
}

.card_preview_area .msg_area {
	*overflow: hidden
}
.msg_card_section {
	position: relative
}

.msg_card_section.shop {
	margin: 0;
	padding: 0;
	border-bottom: 1px dashed #e7e7eb;
	position: relative;
	background-color: #fff;
	border-radius: 5px 5px 0 0;
	-moz-border-radius: 5px 5px 0 0;
	-webkit-border-radius: 5px 5px 0 0
}
.msg_card_section.shop .shop_panel {
	padding: 21px 12px 12px;
	*height: 137px;
	min-height: 137px;
	height: auto;
	text-align: center
}
.msg_card_section.shop .tick_msg {
	margin-bottom: 6px
}
.msg_card_section.shop .tick_msg .card_name {
	font-weight: normal;
	font-size: 28px;
	word-break: break-word;
	word-wrap: break-word
}
.msg_card_section.shop .time {
	text-align: center
}
.card_preview_area .btn {
    display: inline-block;
    overflow: visible;
    padding: 0 22px;
    height: 30px;
    line-height: 30px;
    vertical-align: middle;
    text-align: center;
    text-decoration: none;
    border-radius: 3px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    font-size: 14px;
    border-width: 1px;
    border-style: solid;
    cursor: pointer;
}
.btn_use_card {
	border-width: 0;
	background-color: #f4f5f9
}
.btn_use_card[style^="background"] {
	color: #fff
}
.card_usage {
	text-align: left;
	padding: 0 10px 1em;
	background-color: #fff
}
.card_usage li {
	overflow: hidden;
	padding-left: 5em;
	clear: both;
	color: #8d8d8d
}
.card_usage .usage_label {
	float: left;
	margin-left: -5em;
	color: #222
}
</style>
<form action="" method="post" class="form-horizontal form" enctype="multipart/form-data" id="form" onsubmit="return false">
<input type="hidden" name="id" value="{$coupon['id']}">
<ul class="we7-page-tab" style="margin-top: 0;margin-top: -20px">
    <li class="active" ><a href="javascript:;">填写优惠券信息</a></li>
</ul>
<div class="tab-content">
	<div class="tab-pane active" style="display: flex;">
		<div class="card_preview_area js_color_bg_preview affix-top" style="height: 1%">
			<div class="card_body" id="js_preview_area">
				<div class="js_preview msg_card_section shop disabled">
					<div class="shop_panel">
						<div class="logo_area">
							<span class="logo">
							<img id="js_logo_url_preview" src="../addons/deam_food/static/images/no-img.jpg">
							</span>
							<p id="js_brand_name_preview">商户名称</p>
						</div>
						<div class="msg_area">
							<div class="tick_msg">
								<p id="js_title_preview" class="card_name">卡券标题</p>
								<span class="btn btn_use_card js_use_card_button" id="js_color_preview">使用</span>
							</div>

							<div class="js_card_pay_money_tips" style="display:none;">
							</div>
						</div>
					</div>
					<div class="card_usage">
						<ul>
						<li><span class="usage_label" id="js_use_condition_preview_p" style="display: none;">使用条件：</span><span id="js_use_condition_preview"></span></li>
						<li><span class="usage_label">可用时间：</span><span id="js_use_time_preview"></span><span id="js_time_limit_preview">{php echo date('Y.m.d')}-{php echo date('Y.m.d', time() + 30*86400)}</span></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<div id="coupon-form" style="-webkit-box-flex: 1;-webkit-flex: 1;-ms-flex: 1;flex: 1;padding-left: 30px;">
			<!---->
			<div class="panel we7-panel panel-default">
				<ul class="we7-page-tab" id="myTab" style="margin-left: 0;margin-right: 0">
		            <li class="active"><a href="#tab_basic">基本</a></li>
		            <li><a href="#tab_limit">使用限制</a></li>
		            <li><a href="#tab_center">领取设置</a></li>
		        </ul>
		        <div class="tab-content">
					<div class="tab-pane active" id="tab_basic">
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 优惠券类型</label>
							<div class="col-sm-9 col-xs-12">
								 <label class="radio-inline wxcard-radio">
				                    <input type="radio" name="coupon_type" value="0" {if empty($item['coupon_type'])} checked="true"{/if}> 满减券
				                </label>
				                <label class="radio-inline wxcard-radio">
				                    <input type="radio" name="coupon_type" value="1" {if $item['coupon_type'] == '1'} checked="true"{/if}> 折扣券
				                </label>
								<div class="help-block"></div>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 优惠券标题</label>
							<div class="col-sm-9 col-xs-12">
								<input type="text" class="form-control" name="title"/>
								<div class="help-block">不超过18个字符</div>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 col-lg-2 control-label"><span class="text-danger">*</span> 商户LOGO</label>
							
							<div class="col-md-9" id="logo_upload">
								{php echo tpl_form_field_image('logo_url',$goods['img'], '../addons/deam_food/static/images/no-img.jpg');}
							</div>
							
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 商户名称</label>
							<div class="col-sm-9 col-xs-12">
								<input type="text" class="form-control" name="brand_name"/>
								<div class="help-block">商户名字,字数上限为12个汉字。 </div>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 卡券颜色</label>
							{php echo tpl_coupon_colors('color', '');}
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 最低消费</label>
							<div class="col-sm-9 col-xs-12">
								<div class="input-group">
									<span class="input-group-addon">满</span>
									<input type="text" class="form-control" name="least_cost" />
									<span class="input-group-addon">元可用</span>
								</div>
								<div class="help-block">满减券最低消费必须大于减免金额</div>
							</div>
						</div>
						<div class="form-group" id="reduce_cost" {if $item['coupon_type'] == '1'} style="display: none" {/if}>
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 减免金额</label>
							<div class="col-sm-9 col-xs-12">
								<div class="input-group">
									<input type="text" class="form-control" name="reduce_cost"/>
									<span class="input-group-addon">元</span>
								</div>
								<div class="help-block">减免金额只能是大于0.01的数字</div>
							</div>
						</div>
						<div class="form-group" id="discount" {if empty($item['coupon_type'])} style="display: none" {/if}>
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 减免折扣</label>
							<div class="col-sm-9 col-xs-12">
								<div class="input-group">
									<input type="text" class="form-control" name="discount"/>
									<span class="input-group-addon">折</span>
								</div>
								<div class="help-block">请填写0.1-9.9的数字，5折即为购买价 = 原价*0.5。</div>
							</div>
						</div>
						<div class="form-group">
							<label for="" class="col-xs-12 col-sm-3 col-md-2 control-label">卡券分享</label>
							<div class="col-sm-9 col-xs-12">
								<label class="checkbox-inline">
									<input type="checkbox" name="can_share" value="1" id="can_share">用户可以分享领券链接
								</label>
								<label class="checkbox-inline">
									<input type="checkbox" name="can_give_friend" value="1" id="can_give_friend">用户领券后可转赠其他好友
								</label>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label" style="padding-top:15px"> 有效期</label>
							<div class="col-sm-9 col-xs-12">
								<div class="radio">
									<div class="col-sm-3" style="padding-top:6px"><label><input type="radio" value="1" name="time_type" checked/>固定日期 </label></div>
									{php echo tpl_form_field_daterange('time_limit', array('start' => date('Y-m-d'), 'end' => date('Y-m-d', time() + 30*86400)));}
								</div>
								{if $card_type != 'cash'}
								<div class="radio">
									<div class="col-sm-3" style="padding-top:6px"><label><input type="radio" value="2" name="time_type"/>领取后 </label></div>
									<div class="col-sm-3" style="margin-left:-15px">
										<select name="deadline" id="deadline" class="form-control">
											<?php
											for($i=0; $i<=90; $i++) {
												if(!$i) $n = '当'; else $n = $i;
												echo '<option value="'.$i.'">'.$n.'天</option>';
											}
											?>
										</select>
									</div>
									<div class="col-sm-3" style="padding-top:6px">有效,有效期</div>
									<div class="col-sm-3" style="margin-left:-15px">
										<select name="limit" id="limit" class="form-control">
											<?php
											for($i=1; $i<=90; $i++) {
												echo '<option value="'.$i.'">'.$i.'天</option>';
											}
											?>
										</select>
									</div>

								</div>
								{/if}
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 库存</label>
							<div class="col-sm-9 col-xs-12">
								<div class="input-group">
									<input type="text" class="form-control" name="quantity" value="300"/>
									<span class="input-group-addon">份</span>
								</div>
								<div class="help-block">库存只能是大于0的数字</div>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 领券限制</label>
							<div class="col-sm-9 col-xs-12">
								<div class="input-group">
									<input type="text" class="form-control" name="get_limit" value="1"/>
									<span class="input-group-addon">张</span>
								</div>
								<div class="help-block">默认领券限制为1</div>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">优惠共享</label>
							<div class="col-sm-9 col-xs-12">
								<select style="height: 30px;" id="can_use_with_other_discount" name="can_use_with_other_discount" class="form-control">
									<option value="1">可与其他优惠共享</option>
									<option value="0">不与其他优惠共享</option>
								</select>
								<p class="help-block">使用条件的设置会在券上展示，请务必仔细确认。(仅卡券显示用)</p>
							</div>

						</div>
						{if $card_type != 'cash'}
						<div class="form-group"><label class="col-xs-12 col-sm-3 col-md-2 control-label">销券方式</label> <div class="col-sm-9 col-xs-12"><div class="radio"><label><input type="radio" name="code_type" value="1"> 仅卡券号</label> <div class="help-block">只显示卡券号，验证后可进行销券</div></div> <div class="radio"><label><input type="radio" name="code_type" value="2"> 二维码</label> <div class="help-block">包含卡券信息的二维码，扫描后可进行销券</div></div> <div class="radio"><label><input type="radio" name="code_type" value="3" checked="checked"> 条形码</label> <div class="help-block">包含卡券信息的条形码，扫描后可进行销券</div></div></div></div>
						
						<div class="form-group"><label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 操作提示</label> <div class="col-sm-9 col-xs-12"><input type="text" name="notice" id="notice" value="请在付款时出示此券" class="form-control"> <div class="help-block">建议引导用户到店出示卡券，由店员完成核销操作。不超过16个字符</div></div></div>

						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">优惠详情</label>
							<div class="col-sm-9 col-xs-12">
								<textarea name="default_detail" rows="5" class="form-control"></textarea>
								<p class="help-block">文本长度不能超过300字</p>
							</div>
						</div>
						{/if}
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">使用须知</label>
							<div class="col-sm-9 col-xs-12">
								<textarea name="description" rows="5" class="form-control"></textarea>
								<p class="help-block">文本长度不能超过300字</p>
							</div>
						</div>
					</div>
					<div class="tab-pane" id="tab_limit">
						<div class="form-group">
				            <label class="col-xs-12 col-sm-3 col-md-2 control-label">优惠使用限制</label>
				            <div class="col-sm-9 col-xs-12">
				                <label class="radio-inline wxcard-radio">
				                    <input type="radio" name="limitdiscounttype" value="0" {if empty($item['limitdiscounttype'])}checked="true"{/if}> 不添加优惠使用限制
				                </label>
				                <label class="radio-inline wxcard-radio">
				                    <input type="radio" name="limitdiscounttype" value="3" {if $item['limitdiscounttype'] == '3'}checked="true"{/if}> 不允许与其他优惠同时使用
				                </label>
								<p class="help-block">卡券是否可以与特定优惠同时使用</p>
				            </div>

				        </div>
				        <div class="form-group">
				        	<label  class="col-xs-12 col-sm-3 col-md-2 control-label">适用门店</label>
			                <div class="col-sm-9 col-xs-12">
			                	<label class="checkbox-inline"><input class="" type="checkbox" name="store[]" value="{$store_id}" checked="" onclick="return false;"> {$storeinfo['name']}</label>
			                    <p class='help-block'></p>

			                </div>
			            </div>
				        <div class="form-group">
				            <label class="col-xs-12 col-sm-3 col-md-2 control-label">商品使用限制</label>
				            <div class="col-sm-9 col-xs-12">
				                <label class="radio-inline wxcard-radio">
				                    <input type="radio" name="limitgoodstype" value="0" {if empty($coupon_info['limitgoodstype'])}checked="true"{/if} onclick="$('.selectgoods').hide();" /> 不添加商品限制
				                </label>
				                <label class="radio-inline wxcard-radio">
				                    <input type="radio" name="limitgoodstype" value="1" {if $coupon_info['limitgoodstype'] == '1'}checked="true"{/if} onclick="$('.selectgoods').show();" /> 允许以下商品使用
				                </label>
				            </div>
				        </div>
				        <div class="form-group  selectgoods" {if $coupon_info['limitgoodstype']!=1 && $coupon_info['limitgoodstype']!=2}style="display:none"{/if}>
				        	<label  class="col-xs-12 col-sm-3 col-md-2 control-label">选择商品</label>
			                <div class="col-sm-9 col-xs-12">
			                	<select id="goods"  name='goods[]' class="form-control selectpicker" style='width:605px;' multiple='' >
					                {loop $goodsList $c}
					                <option value="{$c['id']}" {if is_array($coupon_info['goods']) &&  in_array($c['id'],$coupon_info['goods'])}selected{/if} >{$c['name']}</option>
					                {/loop}
					            </select>
			                    <p class='help-block'></p>

			                </div>
			            </div>
					</div>
					<div class="tab-pane" id="tab_center">
						<div class="form-group">
				            <label class="col-xs-12 col-sm-3 col-md-2 control-label">首页领取</label>
				            <div class="col-sm-9 col-xs-12">
				                <label class="radio-inline wxcard-radio">
				                    <input type="radio" name="gettype" value="0" {if empty($item['gettype'])}checked="true"{/if}> 不可以
				                </label>
				                <label class="radio-inline wxcard-radio">
				                    <input type="radio" name="gettype" value="1" {if $item['gettype'] == '1'}checked="true"{/if}> 可以
				                </label>
								<p class="help-block">是否在小程序首页显示优惠券领取</p>
				            </div>
				        </div>
				        <div class="form-group">
				            <label class="col-xs-12 col-sm-3 col-md-2 control-label">每日发放</label>
				            <div class="col-sm-9 col-xs-12">
				                <input type="text" class="form-control" name="day_send" value="{$item['day_send']}" />
								<p class="help-block">为0则为每日发放不限制</p>
				            </div>
				        </div>

					</div>
				</div>
			</div>
			
			
			<div class="form-group col-sm-12">
				<input name="submit" type="submit" value="提交" class="btn btn-primary col-lg-1">
				<input type="hidden" name="card_type" value="{$card_type}" />
				<input type="hidden" name="token" value="{$_W['token']}" />
			</div>
		</div>
	</div>
</div>
</form>
<script type="text/javascript">
$(function () {
    window.optionchanged = false;
    $(function () {
	    window.optionchanged = false;
	    $('#myTab a').click(function (e) {
	        e.preventDefault();//阻止a链接的跳转行为
	        $(this).tab('show');//显示当前选中的链接及关联的content
	    })
	    $("[name='coupon_type']").click(function(){
	    	var coupon_type = $(this).val();
	    	if(coupon_type == '0'){
	    		$('#reduce_cost').show();
	    		$('#discount').hide();
	    	}else if(coupon_type == '1'){
	    		$('#reduce_cost').hide();
	    		$('#discount').show();
	    	}
	    });
	});
    $("[name='title']").on("input on",function(){
    	$("#js_title_preview").text($(this).val());
    });
    $("[name='brand_name']").on("input on",function(){
    	$("#js_brand_name_preview").text($(this).val());
    });
    $('#coupon-form').mouseover(function(){
    	var bg_color = $(':input[name="color-value"]').val();
		$('.js_color_bg_preview,#js_color_preview').css('background-color', bg_color);
    	$("#js_logo_url_preview").attr("src",$('#logo_upload img').attr('src'));
    	var time_type = $(':radio[name="time_type"]:checked').val();
		var time = '';
		if(time_type == 1) {
			var startime = $("input[name='time_limit[start]']").val();
			var endtime = $("input[name='time_limit[end]']").val();
			time = startime.replace(/\-/g, ".")+'-'+endtime.replace(/\-/g, ".");
		} else if(time_type == 2) {
			var deadline = parseInt($('#deadline').val());

			var limit = parseInt($('#limit').val());
			var now = new Date();
			now.setHours(0, 0, 0);
			var unixtime =Date.parse(now)/1000;
			unixtime += (deadline*86400);
			var startime = new Date(parseInt(unixtime) * 1000).toLocaleString().substr(0,10).replace(/\//g, ".").replace(/ /g, "");
			unixtime += (limit*86400);
			var endtime = new Date(parseInt(unixtime) * 1000).toLocaleString().substr(0,10).replace(/\//g, ".").replace(/ /g, "");
			time = startime+'-'+endtime;
		}
		$('#js_time_limit_preview').html(time);
    })
    $('#form').submit(function(){
    	if(!$.trim($(':input[name="title"]').val())) {
			util.message('标题不能为空', '','error');
			return false;
		}
		if(!$.trim($(':input[name="brand_name"]').val())) {
			util.message('请填写商户名称', '','error');
			return false;
		}
    	if(!$.trim($(':input[name="color-value"]').val())) {
			util.message('请选择卡券颜色', '','error');
			return false;
		}
		if((!($(':text[name="reduce_cost"]').val() >= 0.01)) && coupon_type == '0') {
			util.message("减免金额不合法",'','error');
			return false;
		}
		var reduce_cost = parseFloat($(':text[name="reduce_cost"]').val());
		var least_cost = parseFloat($(':text[name="least_cost"]').val());
		var discount = parseFloat($(':text[name="discount"]').val());
		var coupon_type = $("[name='coupon_type']").val();
		if(reduce_cost >= least_cost && coupon_type == '0') {
			util.message("最低消费必须大于减免金额",'','error');
			return false;
		}
		if(coupon_type == '1' && (discount < 0.1 || discount > 9.9) ){
			util.message("减免折扣不在有效范围内",'','error');
			return false;
		}
		var quantity = parseInt($.trim($(':text[name="quantity"]').val()));
		if(isNaN(quantity)) {
			util.message("库存只能是大于0的数字",'','error');
			return false;
		}
		var time_type = $(':radio[name="time_type"]:checked').val();
		if(!time_type) {
			util.message('请完善卡券有效期', '','error');
			return false;
		}
		var code_type = $(':radio[name="code_type"]:checked').val();
		{if $card_type != 'cash'}
		if(!code_type) {
			util.message('请选择销券方式','','error');
			return false;
		}
		if(!$.trim($(':text[name="notice"]').val())) {
			util.message('请完善操作提示', '','error');
			return false;
		}
		if(!$.trim($('textarea[name="default_detail"]').val())) {
			util.message('请填写优惠详情', '','error');
			return false;
		}
		{/if}
		if(!$.trim($('textarea[name="description"]').val())) {
			util.message('请完善使用须知', '','error');
			return false;
		}
		jQuery.ajax({
            type: "post",
            dataType: "json",
            url: "{php echo manage_url(array('r'=>'sales','ac'=>'index','op'=>'post_data'))}",
            cache: false,
            data: $("#form").serialize(),
            success: function(res){
            	if(res.status == '1'){
            		util.message(res.result.message, '','success');
            		setTimeout(function(){
            			window.location.href="{php echo manage_url(array('r'=>'sales','ac'=>'index'))}";
            		}, 2000);
            	}else{
            		util.message(res.result.message, '','error');
            	}
                
            }
        });
		return false;
    })
});
</script>
{elseif $operation == 'detail'}
<style type="text/css">
.dm-content{
	
}
.card_preview_area {
	float: left;
    width: 318px;
    margin-right: 16px;
    padding-bottom: 150px;
    overflow: hidden;
    background: {$coupon_colors[$coupon_info['color']]} url(../addons/deam_food/static/images/topbar_white.png) no-repeat center 5px;
}
.card_preview_area[style^="background-color"] {
    background-image: url(../addons/deam_food/static/images/topbar_white.png);
}
.card_preview_area .card_body {
    margin: 64px 10px 10px;
}
.card_preview_area .msg_card_cell {
	background-color: #fff;
	*zoom: 1
}

.card_preview_area .logo_area {
	position: relative;
	margin-bottom: 7px;
	line-height: 42px;
	color: #8d8d8d;
	margin-top: -40px
}

.card_preview_area .logo {
	display: block;
	width: 38px;
	height: 38px;
	padding-top: 0;
	margin: 0 auto;
	border-radius: 22px;
	-moz-border-radius: 22px;
	-webkit-border-radius: 22px;
	float: none;
	border: 1px solid #e7e7eb;
	background-color: #fff
}

.card_preview_area .logo img {
	display: block;
	width: 100%;
	height: 100%;
	border-radius: inherit;
	-moz-border-radius: inherit;
	-webkit-border-radius: inherit
}

.card_preview_area .logo img[src=""] {
	display: none
}

.card_preview_area .logo img[src="http"] {
	display: block
}

.card_preview_area .logo img[src="//"] {
	display: block
}

.card_preview_area .msg_area {
	*overflow: hidden
}
.msg_card_section {
	position: relative
}

.msg_card_section.shop {
	margin: 0;
	padding: 0;
	border-bottom: 1px dashed #e7e7eb;
	position: relative;
	background-color: #fff;
	border-radius: 5px 5px 0 0;
	-moz-border-radius: 5px 5px 0 0;
	-webkit-border-radius: 5px 5px 0 0
}
.msg_card_section.shop .shop_panel {
	padding: 21px 12px 12px;
	*height: 137px;
	min-height: 137px;
	height: auto;
	text-align: center
}
.msg_card_section.shop .tick_msg {
	margin-bottom: 6px
}
.msg_card_section.shop .tick_msg .card_name {
	font-weight: normal;
	font-size: 28px;
	word-break: break-word;
	word-wrap: break-word
}
.msg_card_section.shop .time {
	text-align: center
}
.card_preview_area .btn {
    display: inline-block;
    overflow: visible;
    padding: 0 22px;
    height: 30px;
    line-height: 30px;
    vertical-align: middle;
    text-align: center;
    text-decoration: none;
    border-radius: 3px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    font-size: 14px;
    border-width: 1px;
    border-style: solid;
    cursor: pointer;
}
.btn_use_card {
	border-width: 0;
	background-color: #f4f5f9
}
.btn_use_card[style^="background"] {
	color: #fff
}
.card_usage {
	text-align: left;
	padding: 0 10px 1em;
	background-color: #fff
}
.card_usage li {
	overflow: hidden;
	padding-left: 5em;
	clear: both;
	color: #8d8d8d
}
.card_usage .usage_label {
	float: left;
	margin-left: -5em;
	color: #222
}
</style>

<form action="" method="post" class="form-horizontal form" enctype="multipart/form-data" id="form">
<input type="hidden" name="id" value="{$coupon_info['id']}">
<ul class="we7-page-tab" style="margin-top: 0;margin-top: -20px">
    <li class="active" ><a href="javascript:;">优惠券详情</a></li>
</ul>
<div class="tab-content">
	<div class="tab-pane active" style="display: flex;">
		<div class="card_preview_area js_color_bg_preview affix-top" style="height: 1%;">
			<div class="card_body" id="js_preview_area">
				<div class="js_preview msg_card_section shop disabled">
					<div class="shop_panel">
						<div class="logo_area">
							<span class="logo">
							<img id="js_logo_url_preview" src="{media $coupon_info['logo_url']}">
							</span>
							<p id="js_brand_name_preview">{$coupon_info['brand_name']}</p>
						</div>
						<div class="msg_area">
							<div class="tick_msg">
								<p id="js_title_preview" class="card_name">{$coupon_info['title']}</p>
								<span class="btn btn_use_card js_use_card_button" id="js_color_preview" style="background: {$coupon_colors[$coupon_info['color']]}">使用</span>
							</div>

							<div class="js_card_pay_money_tips" style="display:none;">
							</div>
						</div>
					</div>
					<div class="card_usage">
						<ul>
						<li><span class="usage_label" id="js_use_condition_preview_p" style="display: none;">使用条件：</span><span id="js_use_condition_preview"></span></li>
						<li><span class="usage_label">可用时间：</span><span id="js_use_time_preview"></span><span id="js_time_limit_preview">{$coupon_info['date_info']}</span></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<div id="coupon-form" style="-webkit-box-flex: 1;-webkit-flex: 1;-ms-flex: 1;flex: 1;padding-left: 30px;">
			<div class="panel we7-panel panel-default">
				<ul class="we7-page-tab" id="myTab" style="margin-left: 0;margin-right: 0">
		            <li class="active"><a href="#tab_basic">基本</a></li>
		            <li><a href="#tab_limit">使用限制</a></li>
		            <li><a href="#tab_center">领取设置</a></li>
		        </ul>
		        <div class="tab-content">
					<div class="tab-pane active" id="tab_basic">
						<div class="form-group marbot0">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 卡券id</label>
							<div class="col-sm-9 col-xs-12">
								<p class="form-control-static">{$coupon_info['card_id']}</p>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 优惠券标题</label>
							<div class="col-sm-9 col-xs-12">
								<p class="form-control-static">{$coupon_info['title']}</p>
								<div class="help-block"></div>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 商户名称</label>
							<div class="col-sm-9 col-xs-12">
							<p class="form-control-static">{$coupon_info['brand_name']}</p>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 最低消费</label>
							<div class="col-sm-9 col-xs-12">
								<p class="form-control-static">满 {php echo $coupon_info['least_cost']/100} 元可用</p>
							</div>
						</div>
						{if $coupon_info['coupon_type'] == '0'}
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 减免金额</label>
							<div class="col-sm-9 col-xs-12">
								<p class="form-control-static">减 {php echo $coupon_info['reduce_cost']/100} 元</p>
							</div>
						</div>
						{elseif $coupon_info['coupon_type'] == '1'}
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 减免折扣</label>
							<div class="col-sm-9 col-xs-12">
								<p class="form-control-static">{php echo $coupon_info['discount']/100} 折</p>
							</div>
						</div>
						{/if}
						<div class="form-group marbot0">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 分享设置</label>
							<div class="col-sm-9 col-xs-12">
								<p class="form-control-static">
									{if $coupon_info['can_share']}用户可以分享领券链接{else}用户不能分享领券链接{/if}
								</p>
							</div>
						</div>
						<div class="form-group marbot0">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 转赠设置</label>
							<div class="col-sm-9 col-xs-12">
								<p class="form-control-static">
									{if $coupon_info['can_give_friend']}用户领券后可转赠其他好友{else}用户领券后不能转赠其他好友{/if}
								</p>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label" style="padding-top:15px"> 有效期</label>
							<div class="col-sm-9 col-xs-12">
								<p class="form-control-static">{$coupon_info['date_info']}</p>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 库存</label>
							<div class="col-sm-9 col-xs-12">
								<p class="form-control-static">{$coupon_info['quantity']}</p>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 领券限制</label>
							<div class="col-sm-9 col-xs-12">
								<p class="form-control-static">每个用户限领{$coupon_info['get_limit']}张</p>
							</div>
						</div>
						<div class="form-group marbot0">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 销券条码</label>
							<div class="col-sm-9 col-xs-12">
								<p class="form-control-static">
									{if $coupon_info['code_type'] == 1}
									卡号
									{elseif $coupon_info['code_type'] == 2}
									二维码
									{else}
									条形码
									{/if}
								</p>
							</div>
						</div>
						<div class="form-group marbot0">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 操作提示</label>
							<div class="col-sm-9 col-xs-12">
								<p class="form-control-static">
									{$coupon_info['notice']}
								</p>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">优惠详情</label>
							<div class="col-sm-9 col-xs-12">
								<p class="form-control-static">
									{$coupon_info['extra']['default_detail']}
								</p>
							</div>
						</div>
						<div class="form-group marbot0">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 使用须知</label>
							<div class="col-sm-9 col-xs-12">
								<p class="form-control-static">
									{$coupon_info['description']}
								</p>
							</div>
						</div>
					</div>
					<div class="tab-pane" id="tab_limit">
						<div class="form-group">
				            <label class="col-xs-12 col-sm-3 col-md-2 control-label">优惠使用限制</label>
				            <div class="col-sm-9 col-xs-12">
				                <label class="radio-inline wxcard-radio">
				                    <input type="radio" name="limitdiscounttype" value="0" {if empty($coupon_info['limitdiscounttype'])}checked="true"{/if}> 不添加优惠使用限制
				                </label>
				                <label class="radio-inline wxcard-radio">
				                    <input type="radio" name="limitdiscounttype" value="3" {if $coupon_info['limitdiscounttype'] == '3'}checked="true"{/if}> 不允许与其他优惠同时使用
				                </label>
								<p class="help-block">卡券是否可以与特定优惠同时使用</p>
				            </div>

				        </div>
				        <div class="form-group">
				        	<label  class="col-xs-12 col-sm-3 col-md-2 control-label">适用门店</label>
			                <div class="col-sm-9 col-xs-12">
			                	<label class="checkbox-inline"><input class="" type="checkbox" name="store[]" value="{$store_id}" checked="" onclick="return false;"> {$storeinfo['name']}</label>
			                    <p class='help-block'></p>

			                </div>
			            </div>
			            <div class="form-group">
				            <label class="col-xs-12 col-sm-3 col-md-2 control-label">商品使用限制</label>
				            <div class="col-sm-9 col-xs-12">
				                <label class="radio-inline wxcard-radio">
				                    <input type="radio" name="limitgoodstype" value="0" {if empty($coupon_info['limitgoodstype'])}checked="true"{/if} onclick="$('.selectgoods').hide();" /> 不添加商品限制
				                </label>
				                <label class="radio-inline wxcard-radio">
				                    <input type="radio" name="limitgoodstype" value="1" {if $coupon_info['limitgoodstype'] == '1'}checked="true"{/if} onclick="$('.selectgoods').show();" /> 允许以下商品使用
				                </label>
				            </div>
				        </div>
				        <div class="form-group  selectgoods" {if $coupon_info['limitgoodstype']!=1 && $coupon_info['limitgoodstype']!=2}style="display:none"{/if}>
				        	<label  class="col-xs-12 col-sm-3 col-md-2 control-label">选择商品</label>
			                <div class="col-sm-9 col-xs-12">
			                	<select id="goods"  name='goods[]' class="form-control selectpicker" style='width:605px;' multiple='' >
					                {loop $goodsList $c}
					                <option value="{$c['id']}" {if is_array($coupon_info['goods']) &&  in_array($c['id'],$coupon_info['goods'])}selected{/if} >{$c['name']}</option>
					                {/loop}
					            </select>
			                    <p class='help-block'></p>

			                </div>
			            </div>
					</div>
					<div class="tab-pane" id="tab_center">
						<div class="form-group">
				            <label class="col-xs-12 col-sm-3 col-md-2 control-label">首页领取</label>
				            <div class="col-sm-9 col-xs-12">
				                <label class="radio-inline wxcard-radio">
				                    <input type="radio" name="gettype" value="0" {if empty($coupon_info['gettype'])}checked="true"{/if}> 不可以
				                </label>
				                <label class="radio-inline wxcard-radio">
				                    <input type="radio" name="gettype" value="1" {if $coupon_info['gettype'] == '1'}checked="true"{/if}> 可以
				                </label>
								<p class="help-block">是否在小程序首页显示优惠券领取</p>
				            </div>

				        </div>
				        <div class="form-group">
				            <label class="col-xs-12 col-sm-3 col-md-2 control-label">每日发放</label>
				            <div class="col-sm-9 col-xs-12">
				                <input type="text" class="form-control" name="day_send" value="{$coupon_info['day_send']}" />
								<p class="help-block">为0则为每日发放不限制</p>
				            </div>
				        </div>
					</div>
				</div>
		    </div>
			
			<div class="form-group col-sm-12">
				<input name="submit" type="submit" value="提交" class="btn btn-primary col-lg-1">
				<input type="hidden" name="card_type" value="{$card_type}" />
				<input type="hidden" name="token" value="{$_W['token']}" />
				<!-- <span class="btn btn-primary col-lg-1" onclick="javascript:history.go(-1)">返回</span> -->
			</div>
		</div>
	</div>
</div>
</form>
<script type="text/javascript">
$(function () {
    window.optionchanged = false;
    $('#myTab a').click(function (e) {
        e.preventDefault();//阻止a链接的跳转行为
        $(this).tab('show');//显示当前选中的链接及关联的content
    });
});
$(document).ready(function () {
        jQuery('.selectpicker').selectpicker();
    });
</script>
{elseif $operation == 'log'}
<div class="we7-page-title">
	{$coupon_info['title']}
	<div class="pull-right">
		<a href="{php echo manage_url(array('r'=>'sales','ac'=>'index'))}" class="btn btn-primary">返回优惠券列表</a>
	</div>
</div>
{if empty($list)}
<div class="panel we7-panel panel-default">
    <div class="panel-body" style="text-align: center;padding:30px;">
       	暂无领取记录
    </div>
</div>
{else}
<div class="table-responsive panel-body">
	<table class="table we7-table table-hover">
		<thead class="navbar-inner">
			<tr>
				<th width="150">优惠券名称</th>
				<th width="90">领取方式</th>
				<th width="210">领取人</th>
				<th width="150">code码</th>
				<th width="60">状态</th>
				<th width="150">领取时间</th>
				<th style="width:150px; text-align:center;">操作</th>
			</tr>
		</thead>
		<tbody>
		{loop $list $k $item}
		<tr>
			<td>{$coupon_info['title']}</td>
			<td>
				{if $item['givebyfriend'] == 1}
				<span class="label label-danger">朋友赠送</span>
				{else}
				<span class="label label-success">{$item['remark']}</span>
				{/if}
			</td>
			<td>{$item['unionid']}</td>
			<td>{$item['code']}</td>
			<td>
			{if TIMESTAMP > $item['endtime']}
				<span class="label label-warning">已失效</span>
			{else}
				{if $item['status'] == 1}
				<span class="label label-success">未使用</span>
				{elseif $item['status'] == 2}
				<span class="label label-warning">已失效</span>
				{elseif $item['status'] == 3}
				<span class="label label-danger">已核销</span>
				{elseif $item['status'] == 4}
				<span class="label label-default">已删除</span>
				{/if}
			{/if}
			</td>
			<td>{php echo date('Y-m-d H:i:s', $item['addtime']);}</td>

			<td style="text-align:center;">
				{if !empty($item['code'])}
					{if $item['status'] == 1 && $item['starttime'] <= TIMESTAMP && $item['endtime'] >= TIMESTAMP }
					<a href="javascript:;" onclick="util.ajaxshow('{php echo $this->createWebUrl('coupon', array('op' => 'coupon_consume', 'id' => $item['id'], 'source' => $row['source']))}')" class="btn btn-default btn-sm" title="核销优惠券">核销</a>
					{/if}
					<a href="javascript:;" onclick="util.ajaxshow('{php echo $this->createWebUrl('coupon', array('op' => 'log_delete', 'id' => $item['id'], 'source' => $row['source']))}')" class="btn btn-default btn-sm" title="删除兑换记录">删除</a>
				{/if}
			</td>
		</tr>
		{/loop}
		</tbody>
	</table>
	{$pager}
</div>
{/if}
{/if}
</div>
</div>
{mtemplate '_footer'}